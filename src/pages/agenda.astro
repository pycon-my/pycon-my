---
import BaseLayout from "../layouts/BaseLayout.astro";
import AgendaCard from "../components/AgendaCard.astro";
import { Talk } from "../talks";

type Speaker = {
  code?: string;
  name: string;
  biography: string;
  avatar?: string;
  email?: string;
};

type Slot = {
  room_id?: number;
  room: {
    en: string;
  };
  start: string;
  end: string;
};

type Talk = {
  code?: string;
  speakers: Speaker[];
  title: string;
  submission_type?: {
    en: string;
  };
  submission_type_id?: number;
  track?: string | null;
  track_id?: string | null;
  state?: string;
  abstract?: string;
  description?: string;
  duration?: number;
  slot_count?: number;
  do_not_record?: boolean;
  is_featured?: boolean;
  content_locale?: string;
  slot: Slot;
  image?: string;
  resources?: string[];
  answers?: string[];
  created?: string;
  pending_state?: string | null;
  notes?: string;
  internal_notes?: string | null;
  tags?: string[];
  tag_ids?: string[];
};

const formatDateTime = (datetime: string | number | Date): string => {
  return new Date(datetime).toLocaleTimeString([], {
    timeZone: "Asia/Kuala_Lumpur",
    hour: "2-digit",
    minute: "2-digit",
  });
};

const filterAndSortTalks = (talks: Talk[], date: string): Talk[] => {
  const targetDate = new Date(date).toISOString().split("T")[0];

  return talks
    .filter((talk) => new Date(talk.slot.start).toISOString().split("T")[0] === targetDate)
    .sort((a, b) => new Date(a.slot.start).getTime() - new Date(b.slot.start).getTime());
};

const groupByStartTime = (talks: Talk[]): Record<string, Talk[]> => {
  return talks.reduce((groups: Record<string, Talk[]>, talk) => {
    const time = formatDateTime(talk.slot.start);
    if (!groups[time]) {
      groups[time] = [];
    }
    groups[time].push(talk);
    return groups;
  }, {});
};

const validateTalks = (talks: any[]): Talk[] => {
  return talks.filter((talk) => {
    return (
      talk.title &&
      talk.abstract &&
      talk.slot &&
      talk.slot.start &&
      talk.slot.end &&
      talk.speakers &&
      Array.isArray(talk.speakers) &&
      talk.speakers.length > 0 &&
      talk.speakers[0].name &&
      talk.speakers[0].biography
    );
  }) as Talk[];
};

const validTalks = validateTalks(Talk);

const sortedTalksDay1 = filterAndSortTalks(validTalks, "2024-08-24");
const sortedTalksDay2 = filterAndSortTalks(validTalks, "2024-08-25");

const groupedTalksDay1 = groupByStartTime(sortedTalksDay1);
const groupedTalksDay2 = groupByStartTime(sortedTalksDay2);
---

<BaseLayout title="Agenda">
  <div class="bg-zinc flex flex-col items-center justify-center py-8">
    <h3 class="my-8 text-black-900 font-bold text-2xl sm:text-6xl">Day 1</h3>
    <span class="text-black-800 text-xl sm:text-2xl">24 August 2024</span>
  </div>
  <div class="px-1 md:pr-32 bg-zinc">
    {Object.entries(groupedTalksDay1).map(([time, talks]) => (
      <div class="grid md:grid-cols-4 gap-4 items-start p-2">
        <div class="hidden md:flex justify-end text-black-600 mt-1">{time}</div>
        <div class={`col-span-${talks.length === 1 ? 3 : 3}`}>
          <div class={`grid grid-cols-1 md:grid-cols-${talks.length} gap-4`}>
            {talks.map((talk) => (
              <AgendaCard
                title={talk.title}
                desc={talk.abstract}
                room={talk.slot.room.en}
                time={`${formatDateTime(talk.slot.start)} - ${formatDateTime(talk.slot.end)}`}
                img={talk.speakers[0]?.avatar}
                name={talk.speakers[0]?.name}
                work={talk.speakers[0]?.biography}
              />
            ))}
          </div>
        </div>
      </div>
    ))}
  </div>

  <div class="bg-zinc flex flex-col items-center justify-center py-8">
    <h3 class="my-8 text-black-900 font-bold text-2xl sm:text-6xl">Day 2</h3>
    <span class="text-black-800 text-xl sm:text-2xl">25 August 2024</span>
  </div>
  <div class="px-1 md:pr-32 bg-zinc">
    {Object.entries(groupedTalksDay2).map(([time, talks]) => (
      <div class="grid md:grid-cols-4 gap-4 items-start p-2">
        <div class="hidden md:flex justify-end text-black-600 mt-1">{time}</div>
        <div class={`col-span-${talks.length === 1 ? 3 : 3}`}>
          <div class={`grid grid-cols-1 md:grid-cols-${talks.length} gap-4`}>
            {talks.map((talk) => (
              <AgendaCard
                title={talk.title}
                desc={talk.abstract}
                room={talk.slot.room.en}
                time={`${formatDateTime(talk.slot.start)} - ${formatDateTime(talk.slot.end)}`}
                img={talk.speakers[0]?.avatar}
                name={talk.speakers[0]?.name}
                work={talk.speakers[0]?.biography}
              />
            ))}
          </div>
        </div>
      </div>
    ))}
  </div>
</BaseLayout>
